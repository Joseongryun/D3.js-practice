<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="http://d3js.org/topojson.v1.min.js"></script>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
  <style>
    html,
    body {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
    }

    .buttons {
      margin: 15px;
    }

    .buttons>* {
      margin-right: 10px;
    }

    #graph {
      border: 2px solid #6C757D;
      width: 500px;
      height: 620px;
      background-image: url('./img/korea.png');
      background-repeat: no-repeat;
      background-position: center center;
      margin: 15px;
      float: left;
    }

    .node text {
      pointer-events: none;
      font: 10px sans-serif;
    }

    .modeStatus {
      float: left;
      margin: 15px;
    }

    .select .node {
      cursor: move;
    }

    .add {
      cursor: crosshair;
    }

    .delete .node,
    .delete .link {
      cursor: crosshair;
    }

    .delete .node:hover,
    .delete .link:hover {
      stroke: orange;
    }

    .link {
      fill: none;
      stroke: #777;
      stroke-width: 4px;
    }

    .svg>g {
      width: 100%;
      height: 100%;
    }
  </style>
</head>

<body>
  <div class="buttons">
    <button class="btn btn-outline-primary btn-sm" onclick="modeChange('select');">선택</button>
    <button class="btn btn-outline-secondary btn-sm" onclick="modeChange('add');">추가</button>
    <button class="btn btn-outline-warning btn-sm" onclick="modeChange('line');">선그리기</button>
    <button class="btn btn-outline-danger btn-sm" onclick="modeChange('delete');">삭제</button>
    <button class="btn btn-outline-success btn-sm" onclick="saveData();">저장</button>
  </div>
  <div id="topo">
    <div id="graph">
    </div>
    <div class="modeStatus">
      현재 모드 :
      <span id="mode">select</span>
    </div>
  </div>
  <script>
    var width = 500,
      height = 620;

    var drag = d3.behavior.drag()
      .origin(function (d) {
        return d;
      })
      .on("dragstart", dragstarted)
      .on("drag", dragged)
      .on("dragend", dragended);

    var modeObj = {
      select: true,
      add: false,
      line: false,
      delete: false
    }

    var mouseDownNode, mouseUpNode;

    var nodes = [];
    var links = [];

    var node, link;

    var force = d3.layout.force()
      .nodes(nodes)
      .links(links)
      .size([width, height])
      .linkDistance(150)
      .charge(-500)

    var zoom = d3.behavior.zoom()
      .scaleExtent([1, 3])
      .on("zoom", zoomed);

    var svg = d3.select("#graph").append("svg")
      .attr('width', width)
      .attr('height', height)
      .attr('class', "select")
      .call(zoom)
      .append('g');

    var projection = d3.geo.mercator()
      .center([128, 36])
      .scale(4000)
      .translate([width / 2, height / 2]);

    svg.on('click', function () {
      var mouse = d3.mouse(this);
      if (modeObj.add) {
        let nodeTemp = {
          id: guid(),
          x: mouse[0],
          y: mouse[1]
        }
        nodes.push(nodeTemp)
        nodeDraw();
      } else {
        return;
      }
    });

    function nodeDraw() {
      svg.selectAll(".node").remove();
      if (nodes == null) {
        return;
      }

      node = svg.selectAll(".node").data(nodes)
        .enter()
        .append("g")
        .attr("class", "node");

      node.attr('transform', function (d) {
          return "translate(" + d.x + "," + d.y + ")"
        })
        .call(drag)
        .on("mousedown", function (d) {
          if (modeObj.line) {
            mouseDownNode = d.id;
          } else return;
        })
        .on("mouseup", function (d) {
          if (modeObj.line) {
            mouseUpNode = d.id;
            if (mouseDownNode == mouseUpNode) {
              return;
            }
            let linkTemp = {
              id: guid(),
              source: mouseDownNode,
              target: mouseUpNode
            }
            if (links.indexOf(linkTemp) != -1) {
              return;
            }
            links.push(linkTemp);
            linkDraw();
            nodeDraw();
          } else return;
        })
        .on("click", function (d) {
          if (modeObj.delete) {
            let deleteIndex = nodes.findIndex(n => n.id == d.id);
            nodes.splice(deleteIndex, 1);
            for (let i = 0; i < links.length; i++) {
              if (links[i].source == d.id || links[i].target == d.id) {
                links.splice(i, 1);
                i--;
              }
            }
            linkDraw();
            nodeDraw();
          }
        });

      node.append("image")
        .attr('x', -15)
        .attr('y', -26.5)
        .attr('width', 30)
        .attr('height', 53)
        .attr("xlink:href", "./img/server.png");

      node.append("text")
        .attr('dx', 0)
        .attr('dy', 26.5)
        .attr('text-anchor', "middle")
        .text("server");
    };

    function linkDraw() {
      if (links == null) {
        return;
      }
      svg.selectAll(".link").remove();
      // links = links.map(l => {
      //   let targetIndex = nodes.findIndex(n => n.id == l.target);
      //   let sourceIndex = nodes.findIndex(n => n.id == l.source);
      //   l.target = {x : nodes[targetIndex].x, y : nodes[targetIndex].y};
      //   l.source = {x : nodes[sourceIndex].x, y : nodes[sourceIndex].y};
      //   console.log(l.target, l.source);
      // })
      let linksTemp = [];

      links.forEach(l => {
        let targetIndex = nodes.findIndex(n => n.id == l.target);
        let sourceIndex = nodes.findIndex(n => n.id == l.source);
        let temp = {
          id: l.id,
          target: {
            x: nodes[targetIndex].x,
            y: nodes[targetIndex].y
          },
          source: {
            x: nodes[sourceIndex].x,
            y: nodes[sourceIndex].y
          }
        }
        linksTemp.push(temp);
      })
      link = svg.selectAll(".link").data(linksTemp)
        .enter()
        .append('path')
        .attr('class', "link")
        .attr('weight', 2);

      link.attr('d', function (d) {
        var dx = d.target.x - d.source.x,
          dy = d.target.y - d.source.y,
          dr = Math.sqrt(dx * dx + dy * dy);
        return "M" + d.source.x + "," + d.source.y + "A" + dr + "," + dr + " 0 0,1 " + d.target.x + "," + d.target.y;
      }).on("click", function (d) {
        if (modeObj.delete) {
          let deleteIndex = links.findIndex(l => l.id == d.id);
          links.splice(deleteIndex, 1);
          linkDraw();
          nodeDraw();
        } else return;
      });

    }

    function zoomed() {
      svg.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
    }

    function dragstarted(d) {
      if (!modeObj.select) {
        return;
      }
      d3.event.sourceEvent.stopPropagation();
      d3.select(this).classed("dragging", true);
    }

    function dragged(d) {
      if (!modeObj.select) {
        return;
      }
      d3.select(this)
        .attr('transform', function (d) {
          d.x = d3.event.x;
          d.y = d3.event.y;
          return "translate(" + d.x + "," + d.y + ")"
        });
      linkDraw();
      nodeDraw();
    }

    function dragended(d) {
      if (!modeObj.select) {
        return;
      }
      d3.select(this).classed("dragging", false);
    }

    function modeChange(mode) {
      for (let key in modeObj) {
        modeObj[key] = false;
      }
      modeObj[mode] = true;
      svg.attr('class', mode);
      document.getElementById("mode").innerHTML = mode;
    }

    function saveData() {
      alert("저장중...");
      localStorage.setItem("topoNode", JSON.stringify(nodes));
      localStorage.setItem("topoLink", JSON.stringify(links));
      alert("저장이 완료되었습니다.");
      window.location.reload();
    }

    function guid() {
      function s4() {
        return Math.floor((1 + Math.random()) * 0x10000)
          .toString(16)
          .substring(1);
      }
      return s4() + s4() + '-' + s4() + '-' + s4() + '-' + s4() + '-' + s4() + s4() + s4();
    }

    window.onload = function () {
      let topoNode = localStorage.getItem("topoNode");
      let topoLink = localStorage.getItem("topoLink");
      if (topoNode == null) {
        nodes = [];
      } else {
        nodes = JSON.parse(topoNode);
      }
      if (topoLink == null) {
        links = [];
      } else {
        links = JSON.parse(topoLink);
        linkDraw();
        nodeDraw();
      }
    }
  </script>
</body>

</html>